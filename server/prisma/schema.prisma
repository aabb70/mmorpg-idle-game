generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 遊戲相關
  level     Int @default(1)
  experience Int @default(0)
  gold      Int @default(100)
  health    Int @default(100)
  maxHealth Int @default(100)
  
  // 技能等級
  skills    Skill[]
  
  // 物品庫存
  inventory InventoryItem[]
  
  // 市場交易
  marketListings MarketListing[]
  purchaseOrders PurchaseOrder[]
  
  // 離線訓練
  offlineTraining OfflineTraining?
  
  // Boss 戰鬥
  bossActions BossAction[]
  
  // 裝備系統
  equipments UserEquipment[]
  
  // 聊天消息
  chatMessages ChatMessage[]
  
  @@map("users")
}

model Skill {
  id       String @id @default(cuid())
  userId   String
  skillType SkillType
  level    Int @default(1)
  experience Int @default(0)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, skillType])
  @@map("skills")
}

model Item {
  id          String @id @default(cuid())
  name        String @unique
  description String
  itemType    ItemType
  category    MaterialCategory?  // 材料分類（魚類、金屬等）
  rarity      Rarity @default(COMMON)
  baseValue   Int @default(0)
  healthRestore Int? // 恢復生命值數量（藥劑類物品）
  
  // 裝備屬性
  equipmentSlot   EquipmentSlot?  // 裝備槽位類型
  requiredSkill   SkillType?      // 技能裝備需要的技能類型
  attackBonus     Int @default(0) // 攻擊力加成
  defenseBonus    Int @default(0) // 防禦力加成
  healthBonus     Int @default(0) // 生命值加成
  skillLevelBonus Int @default(0) // 技能等級加成
  
  // 標籤系統
  tags        ItemTag[]
  
  // 製作需求
  recipes     Recipe[]
  recipeIngredients RecipeIngredient[]
  
  // 庫存項目
  inventoryItems InventoryItem[]
  marketListings MarketListing[]
  
  // 離線訓練目標
  offlineTrainings OfflineTraining[]
  
  // 技能物品關係
  skillItems SkillItem[]
  
  // 用戶裝備關係
  userEquipments UserEquipment[]
  
  // Boss掉落關係
  bossDrops BossItemDrop[]
  
  @@map("items")
}

model Tag {
  id          String @id @default(cuid())
  name        String @unique  // 標籤名稱：油脂、近海、電性、深海、清香等
  description String?
  
  itemTags    ItemTag[]
  recipeIngredients RecipeIngredient[]
  
  @@map("tags")
}

model ItemTag {
  id     String @id @default(cuid())
  itemId String
  tagId  String
  
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([itemId, tagId])
  @@map("item_tags")
}

model Recipe {
  id          String @id @default(cuid())
  itemId      String
  skillType   SkillType
  skillLevel  Int @default(1)
  
  item        Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
  
  @@map("recipes")
}

model RecipeIngredient {
  id       String @id @default(cuid())
  recipeId String
  itemId   String?  // 特定物品需求（可選）
  category MaterialCategory?  // 材料分類需求（可選）
  tagId    String?  // 標籤需求（可選）
  quantity Int
  
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  item   Item?  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag    Tag?   @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@map("recipe_ingredients")
}

model InventoryItem {
  id       String @id @default(cuid())
  userId   String
  itemId   String
  quantity Int
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@unique([userId, itemId])
  @@map("inventory_items")
}

model MarketListing {
  id        String @id @default(cuid())
  sellerId  String
  itemId    String
  quantity  Int
  pricePerUnit Int
  createdAt DateTime @default(now())
  
  seller User @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  item   Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@map("market_listings")
}

model PurchaseOrder {
  id         String @id @default(cuid())
  buyerId    String
  listingId  String
  quantity   Int
  totalPrice Int
  createdAt  DateTime @default(now())
  
  buyer User @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  
  @@map("purchase_orders")
}

enum TrainingMode {
  AUTO_STOP   // 達到指定次數自動停止
  CONTINUOUS  // 持續訓練直到手動停止
}

model OfflineTraining {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  skillType    SkillType
  targetItemId String
  targetItem   Item     @relation(fields: [targetItemId], references: [id])
  
  repetitions  Int      // 要執行的次數 (CONTINUOUS模式下為-1)
  completed    Int      @default(0) // 已完成的次數
  
  trainingMode TrainingMode @default(AUTO_STOP) // 訓練模式
  
  startTime    DateTime @default(now())
  lastUpdate   DateTime @default(now())
  
  isActive     Boolean  @default(true)
  
  @@map("offline_training")
}

model SkillItem {
  id           String    @id @default(cuid())
  skillType    SkillType
  itemId       String
  item         Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  // 最小成功率 (0.0 - 1.0) - 技能等級最低時的成功率
  minSuccessRate  Float   @default(0.3)
  
  // 最大成功率 (0.0 - 1.0) - 技能等級最高時的成功率
  maxSuccessRate  Float   @default(0.8)
  
  // 最低技能等級要求 - 低於此等級無法獲得此物品
  minSkillLevel   Int     @default(1)
  
  // 最高技能等級 - 達到此等級時獲得最大成功率
  maxSkillLevel   Int     @default(50)
  
  // 是否啟用
  isEnabled       Boolean @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([skillType, itemId])
  @@map("skill_items")
}

model UserEquipment {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  slot      EquipmentSlot
  itemId    String?
  item      Item?  @relation(fields: [itemId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, slot])
  @@map("user_equipments")
}

enum SkillType {
  MINING     // 採礦
  LOGGING    // 伐木
  FISHING    // 釣魚
  FORAGING   // 採集
  SMITHING   // 鍛造
  TAILORING  // 裁縫
  COOKING    // 廚師
  ALCHEMY    // 煉金
  CRAFTING   // 工藝
}

enum ItemType {
  MATERIAL   // 原材料
  TOOL       // 工具
  EQUIPMENT  // 裝備
  CONSUMABLE // 消耗品
  FOOD       // 食物
  POTION     // 藥劑
  MISC       // 雜項
}

enum MaterialCategory {
  FISH       // 魚類
  METAL      // 金屬
  WOOD       // 木材
  FIBER      // 纖維/皮革
  HERB       // 香草
  LIVESTOCK  // 畜牧產品
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum EquipmentSlot {
  HEAD               // 頭部
  HANDS              // 手部
  CHEST              // 上衣
  LEGS               // 下褲
  CLOAK              // 披風
  MINING_TOOL        // 採礦工具
  LOGGING_TOOL       // 伐木工具
  FISHING_TOOL       // 釣魚工具
  FORAGING_TOOL      // 採集工具
  SMITHING_TOOL      // 鍛造工具
  TAILORING_TOOL     // 裁縫工具
  COOKING_TOOL       // 廚師工具
  ALCHEMY_TOOL       // 煉金工具
  CRAFTING_TOOL      // 工藝工具
}

model Boss {
  id          String @id @default(cuid())
  name        String
  description String
  
  // Boss 屬性
  maxHealth   Int @default(100000)
  attack      Int @default(100)
  defense     Int @default(50)
  level       Int @default(1)
  
  // 弱點技能（對這些技能造成額外傷害）
  weaknessSkills SkillType[]
  
  // 掉落獎勵
  goldReward     Int @default(1000)
  expReward      Int @default(500)
  
  // 外觀
  imageUrl    String?
  rarity      Rarity @default(COMMON)
  
  // Boss 實例
  instances   BossInstance[]
  
  // 物品掉落
  itemDrops   BossItemDrop[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("bosses")
}

model BossInstance {
  id        String @id @default(cuid())
  bossId    String
  boss      Boss @relation(fields: [bossId], references: [id], onDelete: Cascade)
  
  // 狀態
  currentHealth Int
  isActive      Boolean @default(true)
  isDefeated    Boolean @default(false)
  
  // 時間控制
  startTime     DateTime @default(now())
  endTime       DateTime
  
  // 戰鬥記錄
  actions       BossAction[]
  
  // 擊殺者
  defeatedBy    String?
  defeatedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("boss_instances")
}

model BossAction {
  id             String @id @default(cuid())
  
  bossInstanceId String
  bossInstance   BossInstance @relation(fields: [bossInstanceId], references: [id], onDelete: Cascade)
  
  userId         String
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 攻擊詳情
  damage         Int
  skillUsed      SkillType
  isCritical     Boolean @default(false)
  
  // 玩家狀態（攻擊時）
  playerLevel    Int
  skillLevel     Int
  
  createdAt      DateTime @default(now())
  
  @@map("boss_actions")
}

model BossItemDrop {
  id        String @id @default(cuid())
  bossId    String
  boss      Boss @relation(fields: [bossId], references: [id], onDelete: Cascade)
  
  itemId    String
  item      Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  // 掉落機率 (0.0 - 1.0)
  dropRate  Float @default(0.1)
  
  // 掉落數量範圍
  minQuantity Int @default(1)
  maxQuantity Int @default(1)
  
  // 是否只給擊殺者
  killerOnly Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([bossId, itemId])
  @@map("boss_item_drops")
}

model BossSettings {
  id                    String @id @default(cuid())
  
  // 自動切換設置
  autoSwitchEnabled     Boolean @default(true)
  autoSwitchDelayHours  Int @default(1)        // Boss被擊敗後多久自動切換下一個 (小時)
  
  // Boss實例持續時間
  defaultDurationHours  Int @default(24)       // 新Boss實例的預設持續時間 (小時)
  
  // Boss選擇規則
  bossSelectionMode     BossSelectionMode @default(RANDOM)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("boss_settings")
}

enum BossSelectionMode {
  RANDOM      // 隨機選擇
  SEQUENTIAL  // 按等級順序
  WEIGHTED    // 按稀有度權重
}

model ChatMessage {
  id        String @id @default(cuid())
  
  // 發送者
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 消息內容
  content   String
  messageType ChatMessageType @default(GENERAL)
  
  // 時間戳
  createdAt DateTime @default(now())
  
  // 是否被管理員刪除
  isDeleted Boolean @default(false)
  deletedBy String?
  deletedAt DateTime?
  
  @@map("chat_messages")
}

enum ChatMessageType {
  GENERAL     // 一般聊天
  SYSTEM      // 系統訊息
  BOSS_DEFEAT // Boss擊敗公告
  LEVEL_UP    // 升級公告
}